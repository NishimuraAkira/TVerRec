# :tv:**TVerRec**:tv: - TVer 一括ダウンロード -

TVerRecは、動画配信サイトTVer ( ティーバー <https://tver.jp/> ) の動画を録画保存するためのダウンローダー、ダウンロードツールです。

ざっくり以下のようなことができます。

1. 動画のジャンルや出演タレント、番組名などのキーワード指定して一括ダウンロードします。
    - CMは入っていないため気に入った番組を配信終了を気にすることなくいつまでも残しておくことができます。
    - TVerRecはループ実行するようになっているので、1回起動すれば新しい番組が配信される都度ダウンロードされるようになります。
2. TVerの全録が可能です。
    - ちまちまURLをコピペしたり画面録画する必要はなく、起動して放置するだけです。控えめに言って最高です。
3. もちろん動画を1本ずつ指定したダウンロードも可能です。
    - なかには全録なんかしてられねーよ、という方もいらっしゃることでしょう。安心してください。
    - 動画のURLを指定することでダウンロードしたい動画を1本ずつ指定することも可能です。
4. また、ダウンロード保存した動画が正常に再生できるかどうかの検証も行います。
    - もし動画ファイルが壊れている場合には自動的に再ダウンロードします。
    - 動画の検証時にffmpegを使用しますが、ハードウェアアクセラレーションを使えば、CPU使用率を抑えることができます。(使用するPCでの性能によっては処理時間が長くなることがあります。その場合はハードウェアアクセラレーションを無効化できます)
5. 動作に必要なyt-dlpやffmpegなどの必要コンポーネントは自動的に最新版がダウンロードされます。(Windowsのみ)
6. yt-dlpの機能を活用しているため、日本国外からもVPNを使わずに安心して利用することができます。

## 前提条件

Windows10とWindows11で動作確認していますが、おそらくWindows7、8でも動作します。
Windows PowerShell 5.1とPowerShell Core 7.2の双方で動作しています。おそらくそれ以外のVersionでも動作すると思います。

PowerShellはMacOS、Linuxにも移植されてるので動作するはずです。
一応、PowerShell 7.2をインストールしたRaspberry Pi OSで簡易に動作確認をしています。([参考](https://docs.microsoft.com/ja-jp/powershell/scripting/install/install-raspbian?view=powershell-7.2))
MacOSでもPowerShellをインストールし簡易に動作確認をしています。([参考](https://docs.microsoft.com/ja-jp/powershell/scripting/install/installing-powershell-on-macos?view=powershell-7.2))

## 実行方法

以下の手順でバッチファイルを実行してください。

1. `git clone`、またはTVerRecをダウロードして任意のディレクトリで解凍してください。
2. [環境設定方法](#環境設定方法)、[ダウンロード対象の設定方法](#ダウンロード対象の設定方法)、[ダウンロード対象外の番組の設定方法](#ダウンロード対象外の番組の設定方法)を参照して環境設定、ダウンロード設定を行ってください。
3. Windows環境では `win/start_tverrec.bat`を実行してください。
    - 処理が完了しても10分ごとに永遠にループして稼働し続けます。
    - 上記でPowerShellが起動しない場合は、PowerShell の実行ポリシーのRemoteSignedなどに変更する必要があるかもしれません。([参考](https://docs.microsoft.com/ja-jp/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-7.2))
    - LinuxやMacOSも基本的に同じ使い方ですが、以下の章を参照してください。
4. TVerRecを `win/start_tverrec.bat`で起動した場合は、`win/stop_tverrec.bat`でTVerRecを停止できます。
    - 関連するダウンロード処理もすべて強制停止されるので注意してください。
    - ダウンロードを止めたくない場合は、tverecのウィンドウを閉じるボタンで閉じてください。
5. TVerRecを `win/start_tverrec.bat`で実行している各ツールを個別に起動するために、`win/a.download_video.bat` / `win/b.delete_trash.bat` / `win/c.validate_video.bat` / `win/d.move_video.bat`を使うこともできます。それぞれ、動画のダウンロドード、無視した動画やダウンロード中断時のゴミファイルの削除、ダウンロードした動画の検証、検証した動画の保存先への移動を行います。(`win/start_tverrec.bat`はこれらを自動的に、且つ無限に実行します)

個別の設定はテキストエディタで変更する必要があります。

### 環境設定方法

- `conf/user_setting.conf`をテキストエディターで開いてユーザ設定を行ってください。
  - `$downloadBasePath`には動画をダウンロードするフォルダを設定します
  - `$saveBasePath`にはダウンロードした動画を移動する先のフォルダを設定します
  - `$moveToParentNameList`には`$saveBasePath`配下に存在するフォルダをカンマ区切りで設定します
    - ここで設定したフォルダ配下にあるフォルダと`$downloadBasePath`にあるフォルダが一致する場合、動画ファイルが`$downloadBasePath`から`$saveBasePath`配下の各フォルダ配下に移動されます
  - `$parallelDownloadNum`は同時に並行で実行するダウンロード数を設定します
  - `$windowStyle`にはyt-dlpのウィンドウをどのように表示するかを設定します
    - `Normal` / `Maximized` / `Minimized` / `Hidden` の4つが指定可能です
  - `$forceSoftwareDecode`に`$true`を設定するとハードウェアアクセラレーションを使わなくなります
    - 高速なCPUが搭載されている場合はハードウェアアクセラレーションよりもCPUで処理したほうが早い場合があります
    - ハードウェアアクセラレーション方式の検出がうまくいかない場合(動画の検証が全く進まない場合)にも`$true`に設定してください

### ダウンロード対象の設定方法

- `conf/keyword.conf`をテキストエディターで開いてダウンロード対象のタレントの名前や番組名、ジャンル、TV局などを設定します。
  - 不要なキーワードは `#` でコメントアウトするか削除してください。
  - 主なジャンルは網羅しているつもりですが、不足があるかもしれませんので、必要に応じて適宜自分で補ってください。

### ダウンロード対象外の番組の設定方法

- `con/ignore.conf`をテキストエディターで開いて、ダウンロードしたくない番組名を設定します。
  - キワードにマッチする動画は全てダウンロードされるので、場合によってはダウンロードしたくない番組もまとめてダウンロードされるます。そのような時には個別にダウンロード対象外に指定できます。

## おすすめの使い方

- TVerのカテゴリ毎のページを指定して`win/start_tverrec.bat`で起動すれば、新しい番組が配信されたら自動的にダウンロードされるようになります。
- 同様に、フォローしているタレントや番組名を指定して`win/start_tverrec.bat`で起動すれば、新しい番組が配信されたら自動的にダウンロードされるようになります。
- 同様に、各放送局毎のページを指定して`win/start_tverrec.bat`で起動すれば、新しい番組が配信されたら自動的にダウンロードされるようになります。

## Linux/Macでの利用方法

- `ffmpeg`と`yt-dlp`を`bin`ディレクトリに配置するか、シンボリックリンクを貼ってください。
  - または、`conf/system_setting.conf`に相対パス指定で`ffmpeg`と`yt-dlp`のパスを記述してください。
- 上記説明の`win/*.bat`は`unix/*.sh`に読み替えて実行してください。

## フォルダ構成

```text
tverrec/
├─ bin/ .................................. 実行ファイル格納用フォルダ
│
├─ conf/ ................................. 設定フォルダ
│  ├─ ignore.conf .......................... ダウンロード対象外設定ファイル
│  ├─ keyword.conf ......................... ダウンロード対象ジャンル設定ファイル
│  ├─ system_setting.conf .................. システム設定ファイル
│  └─ user_setting.conf .................... ユーザ設定ファイル
│
├─ db/ ................................... データベース
│  └─ tver.csv ............................. ダウンロードリスト
│
├─ src/ .................................. 各種ソース
│  ├─ common_functions.ps1 ................. 共通関数定義
│  ├─ delete_trash.ps1 ..................... ダウンロード対象外ビデオ削除ツール
│  ├─ move_vide.ps1 ........................ ビデオを保存先に移動するツール
│  ├─ tver_functions.ps1 ................... TVer用共通関数定義
│  ├─ tverrec_bulk.ps1 ..................... 一括ダウンロードツール本体
│  ├─ tverrec_single.ps1 ................... 単体ダウンロードツール
│  ├─ update_ffmpeg.ps1 .................... ffmpeg自動更新ツール
│  ├─ update_yt-dlp.ps1 .................... yt-dlp自動更新ツール
│  └─ validate_video.ps1 ................... ダウンロード済みビデオの整合性チェックツール
│
├─ unix/ ................................. Linux/Mac用シェルスクリプト
│  ├─ a.download_video.sh .................. 一括ダウンロードするシェルスクリプト
│  ├─ b.delete_video.sh .................... ダウンロード対象外ビデオ・中間ファイル削除シェルスクリプト
│  ├─ c.validate_video.sh .................. ダウンロード済みビデオの整合性チェックシェルスクリプト
│  ├─ d.move_video.sh ...................... ビデオを保存先に移動するシェルスクリプト(もし必要であれば)
│  ├─ z.download_single_video.sh ........... ビデオを1本ずつダウンロードするシェルスクリプト
│  ├─ start_tverrec.sh ..................... 無限一括ダウンロード起動シェルスクリプト
│  └─ stop_tverrec.sh ...................... 無限一括ダウンロード終了シェルスクリプト
│
├─ win/ .................................. Windows用BATファイル
│  ├─ a.download_video.bat ................. 一括ダウンロードするBAT
│  ├─ b.delete_video.bat ................... ダウンロード対象外ビデオ・中間ファイル削除BAT
│  ├─ c.validate_video.bat ................. ダウンロード済みビデオの整合性チェックBAT
│  ├─ d.move_video.bat ..................... ビデオを保存先に移動するBAT(もし必要であれば)
│  ├─ z.download_single_video.bat .......... ビデオを1本ずつダウンロードするBAT
│  ├─ start_tverrec.bat .................... 無限一括ダウンロード起動BAT
│  └─ stop_tverrec.bat ..................... 無限一括ダウンロード終了BAT
│
├─ LICENSE .................................. ライセンス
├─ README.md ................................ このファイル
└─ TODO.md .................................. 今後の改善予定のリスト
```

## アンインストール方法

- レジストリとかめんどくさいものは一切使っていないでの、不要になったらゴミ箱に捨てれば良いです。

## 注意事項

- 著作権について
  - このプログラムの著作権は dongaba が保有しています。

- 事故、故障など
  - 本ツールを使用して起こった何らかの事故、故障などの責任は負いかねますので、ご使用の際はこのことを承諾したうえでご利用ください。

## ライセンス

- TVerRecは[Apache License, Version 2.0のライセンス規約](http://www.apache.org/licenses/LICENSE-2.0)に基づき、複製や再配布、改変が許可されます。

Copyright(c) 2021 dongaba All Rights Reserved.
